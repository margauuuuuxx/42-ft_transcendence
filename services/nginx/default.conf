server {
    listen 80;
    server_name _;

    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name localhost;

    ssl_certificate /etc/nginx/ssl/transcendance.crt;
    ssl_certificate_key /etc/nginx/ssl/transcendance.key;

    location  /jwt_check {
            internal;
            proxy_pass http://auth:3000/jwt_check;
            proxy_set_header Authorization $http_authorization;
            proxy_set_header X-Real-IP $remote_addr;

            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
    }
     location = /mirror-endpoint {
        internal;
        proxy_pass http://users:3000/users/activity;
        proxy_method POST;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-User-Id $user_id;
    }

    location /auth/ {

        proxy_http_version 1.1;
        proxy_set_header Authorization $http_authorization;

        proxy_pass http://auth:3000/;
    }

    # Public user endpoints (no auth required)
    location /users/register {
        proxy_pass http://users:3000/register;
        proxy_http_version 1.1;
        proxy_set_header Content-Type $content_type;
    }
    
    location /users/ {
        auth_request /jwt_check; # cheking the jwt before letting the request go
        mirror /mirror-endpoint;

        auth_request_set $user_id $upstream_http_x_user_id;
        proxy_set_header Authorization $http_authorization;

        proxy_set_header X-User-Id $user_id;
        proxy_pass http://users:3000/;
        proxy_http_version 1.1;
    }

    location /users/activity {
        auth_request /jwt_check;
        auth_request_set $user_id $upstream_http_x_user_id;

        proxy_set_header X-User-Id $user_id;
        proxy_pass http://users:3000/users/activity;
    }

    # Serve source files (templates, compiled JS)
    location /src/ {
        root /var/www/html;
        try_files $uri $uri/ =404;
        add_header Cache-Control "no-cache, must-revalidate";
    }

    # Serve dist files (compiled JS from TypeScript)
    location /dist/ {
        root /var/www/html;
        try_files $uri $uri/ =404;
        add_header Cache-Control "no-cache, must-revalidate";
    }

    # Serve output.css
    location /output.css {
        root /var/www/html;
        try_files $uri =404;
    }

    # Game API routes (if any HTTP endpoints exist)
    location /api/game/ {
        auth_request /jwt_check;

        # Mirror activity update (non-blocking)
        mirror /mirror-endpoint;
        
        auth_request_set $user_id $upstream_http_x_user_id;
        proxy_set_header Authorization $http_authorization;
        
        proxy_set_header X-User-Id $user_id;
        proxy_pass http://game:7777/;
        proxy_http_version 1.1;
    }

    # game server websocket (no mirror for websockets)
    location /wss/game {
        proxy_pass http://game:7777;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
    }

    # Tournament API routes
    location /api/tournament/ {
        proxy_pass http://tournament:3000/;
        proxy_http_version 1.1;
        proxy_set_header Content-Type $content_type;
    }

    # SPA fallback - all other routes serve index.html
    location / {
        root /var/www/html;
        try_files $uri /index.html;
    }
    # distributing avatars images
    location /avatars/ {
        # auth_request /jwt_check; 

        alias /var/www/avatars/;
        autoindex off;
    }

}